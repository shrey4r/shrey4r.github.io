<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blow to Switch Image</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background-color: #0b0b0b;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    transition: background 0.4s ease;
  }

  img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
    transition: opacity 0.3s ease;
    user-select: none;
  }

  .hidden {
    opacity: 0;
  }

  .controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: #ccc;
    font-family: monospace;
    text-align: center;
  }

  button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    font-family: monospace;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
  }

  input[type="range"] {
    vertical-align: middle;
  }
</style>
</head>
<body>
  <img id="mainImage" src="image1.jpg" alt="image placeholder">

  <div class="controls">
    <button id="startBtn">ðŸŽ¤ Start Mic</button>
    <button id="stopBtn" disabled>Stop</button>
    <label>
      Threshold:
      <input id="threshold" type="range" min="0.02" max="0.25" step="0.005" value="0.25">
    </label>
    <span id="status">waitingâ€¦</span>
  </div>

<script>
let audioCtx, analyser, source, stream, rafId;
let lastTrigger = 0;
const cooldownMs = 1500;
const img = document.getElementById("mainImage");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");
const thresholdSlider = document.getElementById("threshold");
let userThreshold = parseFloat(thresholdSlider.value);

thresholdSlider.addEventListener("input", () => {
  userThreshold = parseFloat(thresholdSlider.value);
});

startBtn.addEventListener("click", async () => {
  try {
    startBtn.disabled = true;
    statusEl.textContent = "Requesting mic...";
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    statusEl.textContent = "Mic active â€” blow to trigger";
    stopBtn.disabled = false;
    monitor();
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Mic access denied.";
    startBtn.disabled = false;
  }
});

stopBtn.addEventListener("click", stopAll);

function stopAll() {
  if (rafId) cancelAnimationFrame(rafId);
  if (source) source.disconnect();
  if (analyser) analyser.disconnect();
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (audioCtx) audioCtx.close();
  startBtn.disabled = false;
  stopBtn.disabled = true;
  statusEl.textContent = "Mic stopped.";
}

function monitor() {
  const buffer = new Float32Array(analyser.fftSize);
  const check = () => {
    analyser.getFloatTimeDomainData(buffer);
    let sum = 0;
    for (let i = 0; i < buffer.length; i++) sum += buffer[i] * buffer[i];
    const rms = Math.sqrt(sum / buffer.length);
    const now = performance.now();

    if (rms > userThreshold && now - lastTrigger > cooldownMs) {
      lastTrigger = now;
      triggerImageSwap();
    }

    rafId = requestAnimationFrame(check);
  };
  check();
}

function triggerImageSwap() {
  img.classList.add("hidden");
  statusEl.textContent = "Blow detected!";
  setTimeout(() => {
    img.src = img.src.includes("image1.jpg") ? "image2.jpg" : "image1.jpg";
    img.classList.remove("hidden");
  }, 250);
}
</script>
</body>
</html>
