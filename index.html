<script>
  const threshold = 0.25; // mic sensitivity
  const blowDuration = 3250; // duration of compBLOW.gif in ms

  let audioContext, analyser, dataArray;
  let isBlown = false;

  async function initMic() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 512;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      source.connect(analyser);
      listen();
    } catch (err) {
      console.error('Mic access denied:', err);
    }
  }

  function listen() {
    const scene = document.getElementById('scene');
    const btn = document.getElementById('startBtn');

    function checkVolume() {
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a, b) => a + b) / dataArray.length / 255;

      if (avg > threshold && !isBlown) {
        isBlown = true;
        scene.src = 'compBLOW.gif';
        btn.classList.add('fade-out');

        setTimeout(() => {
          scene.src = 'blown.png'; // final post-blow state
        }, blowDuration);
      } else if (!isBlown) {
        requestAnimationFrame(checkVolume);
      }
    }
    requestAnimationFrame(checkVolume);
  }

  document.getElementById('startBtn').addEventListener('click', () => {
    initMic();
    document.getElementById('startBtn').classList.add('fade-out');
  });
</script>
